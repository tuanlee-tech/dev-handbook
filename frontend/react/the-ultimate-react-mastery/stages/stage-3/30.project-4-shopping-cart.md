# üìÖ NG√ÄY 30: ‚ö° Project 4 - Shopping Cart v·ªõi Custom Hooks

## üìç V·ªã tr√≠: Phase 3, Tu·∫ßn 6, Ng√†y 30/45

### ‚è±Ô∏è Th·ªùi l∆∞·ª£ng: 3-4 gi·ªù (Project Day)

---

## üéØ M·ª•c ti√™u h·ªçc t·∫≠p (5 ph√∫t)

Sau b√†i h·ªçc n√†y, b·∫°n s·∫Ω:

- [ ] **Build ƒë∆∞·ª£c** complete shopping cart application
- [ ] **√Åp d·ª•ng ƒë∆∞·ª£c** useReducer cho complex state management
- [ ] **T·∫°o ƒë∆∞·ª£c** multiple custom hooks working together
- [ ] **Implement ƒë∆∞·ª£c** optimistic updates v√† error handling
- [ ] **Persist ƒë∆∞·ª£c** state v·ªõi localStorage

---

## üé® PROJECT OVERVIEW (10 ph√∫t)

### Product Requirements

**"E-Commerce Shopping Cart"** - Full-featured cart nh∆∞ Amazon, Shopify

**Core Features:**

1. ‚úÖ Product catalog display
2. ‚úÖ Add/Remove items to/from cart
3. ‚úÖ Update quantity
4. ‚úÖ Calculate subtotal, tax, total
5. ‚úÖ Apply discount codes
6. ‚úÖ Persist cart to localStorage
7. ‚úÖ Optimistic UI updates
8. ‚úÖ Error handling & retry

**Advanced Features:**

9. ‚úÖ Stock management (out of stock handling)
10. ‚úÖ Clear cart with confirmation
11. ‚úÖ Undo last action
12. ‚úÖ Loading states for async operations

### Tech Stack

```
State Management: useReducer
Custom Hooks: useCart, useProducts, useLocalStorage, useDiscounts
Side Effects: useEffect
Styling: Inline styles (focus on logic, not CSS)
API: Mock API (simulate network delays)
```

### Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         ShoppingApp (Main)              ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  ProductList ‚îÇ  ‚îÇ   ShoppingCart  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  useProducts ‚îÇ  ‚îÇ  useCart        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ  useDiscounts   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  Custom Hooks:                          ‚îÇ
‚îÇ  ‚Ä¢ useCart (cart state + actions)      ‚îÇ
‚îÇ  ‚Ä¢ useProducts (fetch products)        ‚îÇ
‚îÇ  ‚Ä¢ useLocalStorage (persistence)       ‚îÇ
‚îÇ  ‚Ä¢ useDiscounts (discount logic)       ‚îÇ
‚îÇ  ‚Ä¢ useUndo (undo last action)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üíª PH·∫¶N 1: SETUP & DATA LAYER (30 ph√∫t)

### Step 1: Mock Data & API

```jsx
// mockData.js
export const PRODUCTS = [
  {
    id: 1,
    name: 'Wireless Headphones',
    price: 79.99,
    stock: 10,
    image: 'üéß',
    description: 'High-quality wireless headphones',
  },
  {
    id: 2,
    name: 'Smart Watch',
    price: 199.99,
    stock: 5,
    image: '‚åö',
    description: 'Feature-rich smartwatch',
  },
  {
    id: 3,
    name: 'Laptop Stand',
    price: 49.99,
    stock: 15,
    image: 'üíª',
    description: 'Ergonomic laptop stand',
  },
  {
    id: 4,
    name: 'USB-C Hub',
    price: 39.99,
    stock: 20,
    image: 'üîå',
    description: '7-in-1 USB-C hub',
  },
  {
    id: 5,
    name: 'Mechanical Keyboard',
    price: 129.99,
    stock: 8,
    image: '‚å®Ô∏è',
    description: 'RGB mechanical keyboard',
  },
  {
    id: 6,
    name: 'Wireless Mouse',
    price: 29.99,
    stock: 0, // Out of stock
    image: 'üñ±Ô∏è',
    description: 'Ergonomic wireless mouse',
  },
];

export const DISCOUNT_CODES = {
  SAVE10: { type: 'percentage', value: 10, description: '10% off' },
  SAVE20: { type: 'percentage', value: 20, description: '20% off' },
  FLAT15: { type: 'fixed', value: 15, description: '$15 off' },
};

// mockApi.js
import { PRODUCTS } from './mockData';

// Simulate network delay
const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

// Simulate random failures (10% chance)
const shouldFail = () => Math.random() < 0.1;

export const api = {
  // Fetch all products
  getProducts: async () => {
    await delay(500);

    if (shouldFail()) {
      throw new Error('Failed to fetch products');
    }

    return PRODUCTS;
  },

  // Add to cart (simulate API call)
  addToCart: async (productId, quantity) => {
    await delay(300);

    if (shouldFail()) {
      throw new Error('Failed to add to cart');
    }

    return { success: true, productId, quantity };
  },

  // Update cart item
  updateCartItem: async (productId, quantity) => {
    await delay(300);

    if (shouldFail()) {
      throw new Error('Failed to update cart');
    }

    return { success: true, productId, quantity };
  },

  // Remove from cart
  removeFromCart: async (productId) => {
    await delay(300);

    if (shouldFail()) {
      throw new Error('Failed to remove from cart');
    }

    return { success: true, productId };
  },
};
```

### Step 2: useLocalStorage Hook

```jsx
// hooks/useLocalStorage.js
import { useState, useEffect } from 'react';

/**
 * Custom hook to sync state with localStorage
 * @param {string} key - localStorage key
 * @param {any} initialValue - default value
 * @returns {[value, setValue]} - like useState
 */
function useLocalStorage(key, initialValue) {
  // Initialize state
  const [storedValue, setStoredValue] = useState(() => {
    try {
      // Get from localStorage
      const item = window.localStorage.getItem(key);

      // Parse stored json or return initialValue
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error(`Error loading ${key} from localStorage:`, error);
      return initialValue;
    }
  });

  // Update localStorage when state changes
  useEffect(() => {
    try {
      window.localStorage.setItem(key, JSON.stringify(storedValue));
    } catch (error) {
      console.error(`Error saving ${key} to localStorage:`, error);
    }
  }, [key, storedValue]);

  return [storedValue, setStoredValue];
}

export default useLocalStorage;
```

### Step 3: useProducts Hook

```jsx
// hooks/useProducts.js
import { useReducer, useEffect } from 'react';
import { api } from '../mockApi';

// Action Types
const ActionTypes = {
  FETCH_START: 'FETCH_START',
  FETCH_SUCCESS: 'FETCH_SUCCESS',
  FETCH_ERROR: 'FETCH_ERROR',
  RETRY: 'RETRY',
};

// Reducer
function productsReducer(state, action) {
  switch (action.type) {
    case ActionTypes.FETCH_START:
      return {
        ...state,
        loading: true,
        error: null,
      };

    case ActionTypes.FETCH_SUCCESS:
      return {
        products: action.payload,
        loading: false,
        error: null,
      };

    case ActionTypes.FETCH_ERROR:
      return {
        ...state,
        loading: false,
        error: action.payload,
      };

    case ActionTypes.RETRY:
      return {
        ...state,
        loading: true,
        error: null,
      };

    default:
      throw new Error(`Unknown action: ${action.type}`);
  }
}

/**
 * Custom hook to fetch and manage products
 */
function useProducts() {
  const initialState = {
    products: [],
    loading: false,
    error: null,
  };

  const [state, dispatch] = useReducer(productsReducer, initialState);

  const fetchProducts = async () => {
    dispatch({ type: ActionTypes.FETCH_START });

    try {
      const products = await api.getProducts();
      dispatch({ type: ActionTypes.FETCH_SUCCESS, payload: products });
    } catch (error) {
      dispatch({ type: ActionTypes.FETCH_ERROR, payload: error.message });
    }
  };

  // Fetch on mount
  useEffect(() => {
    fetchProducts();
  }, []);

  // Retry function
  const retry = () => {
    dispatch({ type: ActionTypes.RETRY });
    fetchProducts();
  };

  return {
    products: state.products,
    loading: state.loading,
    error: state.error,
    retry,
  };
}

export default useProducts;
```

---

## üíª PH·∫¶N 2: CART LOGIC (45 ph√∫t)

### Step 4: Cart Reducer

```jsx
// reducers/cartReducer.js

export const CartActionTypes = {
  // Optimistic actions
  ADD_ITEM_OPTIMISTIC: 'ADD_ITEM_OPTIMISTIC',
  ADD_ITEM_CONFIRMED: 'ADD_ITEM_CONFIRMED',
  ADD_ITEM_FAILED: 'ADD_ITEM_FAILED',

  UPDATE_QUANTITY_OPTIMISTIC: 'UPDATE_QUANTITY_OPTIMISTIC',
  UPDATE_QUANTITY_CONFIRMED: 'UPDATE_QUANTITY_CONFIRMED',
  UPDATE_QUANTITY_FAILED: 'UPDATE_QUANTITY_FAILED',

  REMOVE_ITEM_OPTIMISTIC: 'REMOVE_ITEM_OPTIMISTIC',
  REMOVE_ITEM_CONFIRMED: 'REMOVE_ITEM_CONFIRMED',
  REMOVE_ITEM_FAILED: 'REMOVE_ITEM_FAILED',

  // Discount
  APPLY_DISCOUNT: 'APPLY_DISCOUNT',
  REMOVE_DISCOUNT: 'REMOVE_DISCOUNT',

  // Other
  CLEAR_CART: 'CLEAR_CART',
  RESTORE_CART: 'RESTORE_CART', // For undo
  SET_ERROR: 'SET_ERROR',
  CLEAR_ERROR: 'CLEAR_ERROR',
};

export const initialCartState = {
  items: [],
  // items format: [{ productId, quantity, product, _optimistic }]

  discount: null,
  // discount: { code, type, value }

  error: null,

  // For undo
  previousState: null,
};

export function cartReducer(state, action) {
  switch (action.type) {
    // ‚úÖ Add Item - Optimistic
    case CartActionTypes.ADD_ITEM_OPTIMISTIC: {
      const { product } = action.payload;

      // Check if item already exists
      const existingIndex = state.items.findIndex(
        (item) => item.productId === product.id,
      );

      if (existingIndex >= 0) {
        // Increment quantity
        const newItems = [...state.items];
        newItems[existingIndex] = {
          ...newItems[existingIndex],
          quantity: newItems[existingIndex].quantity + 1,
          _optimistic: true,
        };

        return {
          ...state,
          items: newItems,
          previousState: state.items, // Save for undo
        };
      } else {
        // Add new item
        return {
          ...state,
          items: [
            ...state.items,
            {
              productId: product.id,
              quantity: 1,
              product,
              _optimistic: true,
            },
          ],
          previousState: state.items,
        };
      }
    }

    case CartActionTypes.ADD_ITEM_CONFIRMED: {
      // Remove optimistic flag
      return {
        ...state,
        items: state.items.map((item) => ({
          ...item,
          _optimistic: false,
        })),
      };
    }

    case CartActionTypes.ADD_ITEM_FAILED: {
      // Rollback to previous state
      return {
        ...state,
        items: state.previousState || state.items,
        error: action.payload.error,
      };
    }

    // ‚úÖ Update Quantity - Optimistic
    case CartActionTypes.UPDATE_QUANTITY_OPTIMISTIC: {
      const { productId, quantity } = action.payload;

      if (quantity <= 0) {
        // Remove item if quantity is 0
        return {
          ...state,
          items: state.items.filter((item) => item.productId !== productId),
          previousState: state.items,
        };
      }

      return {
        ...state,
        items: state.items.map((item) =>
          item.productId === productId
            ? { ...item, quantity, _optimistic: true }
            : item,
        ),
        previousState: state.items,
      };
    }

    case CartActionTypes.UPDATE_QUANTITY_CONFIRMED: {
      return {
        ...state,
        items: state.items.map((item) => ({
          ...item,
          _optimistic: false,
        })),
      };
    }

    case CartActionTypes.UPDATE_QUANTITY_FAILED: {
      return {
        ...state,
        items: state.previousState || state.items,
        error: action.payload.error,
      };
    }

    // ‚úÖ Remove Item - Optimistic
    case CartActionTypes.REMOVE_ITEM_OPTIMISTIC: {
      const { productId } = action.payload;

      return {
        ...state,
        items: state.items.filter((item) => item.productId !== productId),
        previousState: state.items,
      };
    }

    case CartActionTypes.REMOVE_ITEM_CONFIRMED: {
      return state; // Already removed optimistically
    }

    case CartActionTypes.REMOVE_ITEM_FAILED: {
      return {
        ...state,
        items: state.previousState || state.items,
        error: action.payload.error,
      };
    }

    // ‚úÖ Discount
    case CartActionTypes.APPLY_DISCOUNT: {
      return {
        ...state,
        discount: action.payload.discount,
      };
    }

    case CartActionTypes.REMOVE_DISCOUNT: {
      return {
        ...state,
        discount: null,
      };
    }

    // ‚úÖ Clear Cart
    case CartActionTypes.CLEAR_CART: {
      return {
        ...state,
        items: [],
        discount: null,
        previousState: state.items,
      };
    }

    // ‚úÖ Restore (Undo)
    case CartActionTypes.RESTORE_CART: {
      return {
        ...state,
        items: state.previousState || state.items,
        previousState: null,
      };
    }

    // ‚úÖ Error handling
    case CartActionTypes.SET_ERROR: {
      return {
        ...state,
        error: action.payload.error,
      };
    }

    case CartActionTypes.CLEAR_ERROR: {
      return {
        ...state,
        error: null,
      };
    }

    default:
      throw new Error(`Unknown action: ${action.type}`);
  }
}
```

### Step 5: useCart Hook

```jsx
// hooks/useCart.js
import { useReducer, useCallback } from 'react';
import {
  cartReducer,
  initialCartState,
  CartActionTypes,
} from '../reducers/cartReducer';
import { api } from '../mockApi';
import useLocalStorage from './useLocalStorage';

/**
 * Custom hook for shopping cart management
 */
function useCart() {
  // Sync cart with localStorage
  const [persistedCart, setPersistedCart] = useLocalStorage(
    'shopping-cart',
    initialCartState,
  );

  // Initialize reducer with persisted state
  const [state, dispatch] = useReducer(cartReducer, persistedCart);

  // Sync state to localStorage whenever it changes
  // (This happens in useLocalStorage hook)
  useLocalStorage('shopping-cart', state);

  // ‚úÖ Add to cart
  const addToCart = useCallback(async (product) => {
    // Check stock
    if (product.stock <= 0) {
      dispatch({
        type: CartActionTypes.SET_ERROR,
        payload: { error: 'Product is out of stock' },
      });
      return;
    }

    // Optimistic update
    dispatch({
      type: CartActionTypes.ADD_ITEM_OPTIMISTIC,
      payload: { product },
    });

    try {
      // API call
      await api.addToCart(product.id, 1);

      // Confirm
      dispatch({ type: CartActionTypes.ADD_ITEM_CONFIRMED });
    } catch (error) {
      // Rollback
      dispatch({
        type: CartActionTypes.ADD_ITEM_FAILED,
        payload: { error: error.message },
      });
    }
  }, []);

  // ‚úÖ Update quantity
  const updateQuantity = useCallback(async (productId, quantity) => {
    // Optimistic update
    dispatch({
      type: CartActionTypes.UPDATE_QUANTITY_OPTIMISTIC,
      payload: { productId, quantity },
    });

    try {
      // API call
      await api.updateCartItem(productId, quantity);

      // Confirm
      dispatch({ type: CartActionTypes.UPDATE_QUANTITY_CONFIRMED });
    } catch (error) {
      // Rollback
      dispatch({
        type: CartActionTypes.UPDATE_QUANTITY_FAILED,
        payload: { error: error.message },
      });
    }
  }, []);

  // ‚úÖ Remove from cart
  const removeFromCart = useCallback(async (productId) => {
    // Optimistic update
    dispatch({
      type: CartActionTypes.REMOVE_ITEM_OPTIMISTIC,
      payload: { productId },
    });

    try {
      // API call
      await api.removeFromCart(productId);

      // Confirm
      dispatch({ type: CartActionTypes.REMOVE_ITEM_CONFIRMED });
    } catch (error) {
      // Rollback
      dispatch({
        type: CartActionTypes.REMOVE_ITEM_FAILED,
        payload: { error: error.message },
      });
    }
  }, []);

  // ‚úÖ Clear cart
  const clearCart = useCallback(() => {
    if (window.confirm('Are you sure you want to clear the cart?')) {
      dispatch({ type: CartActionTypes.CLEAR_CART });
    }
  }, []);

  // ‚úÖ Undo last action
  const undo = useCallback(() => {
    if (state.previousState) {
      dispatch({ type: CartActionTypes.RESTORE_CART });
    }
  }, [state.previousState]);

  // ‚úÖ Apply discount
  const applyDiscount = useCallback((discount) => {
    dispatch({
      type: CartActionTypes.APPLY_DISCOUNT,
      payload: { discount },
    });
  }, []);

  // ‚úÖ Remove discount
  const removeDiscount = useCallback(() => {
    dispatch({ type: CartActionTypes.REMOVE_DISCOUNT });
  }, []);

  // ‚úÖ Clear error
  const clearError = useCallback(() => {
    dispatch({ type: CartActionTypes.CLEAR_ERROR });
  }, []);

  // ‚úÖ Calculate totals
  const subtotal = state.items.reduce(
    (sum, item) => sum + item.product.price * item.quantity,
    0,
  );

  let discountAmount = 0;
  if (state.discount) {
    if (state.discount.type === 'percentage') {
      discountAmount = subtotal * (state.discount.value / 100);
    } else {
      discountAmount = state.discount.value;
    }
  }

  const tax = (subtotal - discountAmount) * 0.1; // 10% tax
  const total = subtotal - discountAmount + tax;

  // ‚úÖ Cart item count
  const itemCount = state.items.reduce((sum, item) => sum + item.quantity, 0);

  return {
    // State
    items: state.items,
    discount: state.discount,
    error: state.error,

    // Calculations
    subtotal,
    discountAmount,
    tax,
    total,
    itemCount,

    // Actions
    addToCart,
    updateQuantity,
    removeFromCart,
    clearCart,
    undo,
    applyDiscount,
    removeDiscount,
    clearError,

    // Helpers
    canUndo: !!state.previousState,
  };
}

export default useCart;
```

---

## üíª PH·∫¶N 3: DISCOUNT LOGIC (20 ph√∫t)

### Step 6: useDiscounts Hook

```jsx
// hooks/useDiscounts.js
import { useState } from 'react';
import { DISCOUNT_CODES } from '../mockData';

/**
 * Custom hook for discount code management
 */
function useDiscounts() {
  const [inputCode, setInputCode] = useState('');
  const [validationError, setValidationError] = useState(null);

  // Validate and apply discount code
  const validateCode = (code) => {
    const trimmedCode = code.trim().toUpperCase();

    if (!trimmedCode) {
      setValidationError('Please enter a discount code');
      return null;
    }

    const discount = DISCOUNT_CODES[trimmedCode];

    if (!discount) {
      setValidationError('Invalid discount code');
      return null;
    }

    setValidationError(null);
    setInputCode(''); // Clear input on success

    return {
      code: trimmedCode,
      ...discount,
    };
  };

  return {
    inputCode,
    setInputCode,
    validationError,
    validateCode,
    clearError: () => setValidationError(null),
  };
}

export default useDiscounts;
```

---

## üíª PH·∫¶N 4: UI COMPONENTS (60 ph√∫t)

### Step 7: ProductCard Component

```jsx
// components/ProductCard.js
function ProductCard({ product, onAddToCart }) {
  const isOutOfStock = product.stock <= 0;

  return (
    <div
      style={{
        border: '1px solid #ddd',
        borderRadius: '8px',
        padding: '16px',
        textAlign: 'center',
        opacity: isOutOfStock ? 0.6 : 1,
      }}
    >
      <div style={{ fontSize: '48px', marginBottom: '8px' }}>
        {product.image}
      </div>

      <h3 style={{ margin: '8px 0', fontSize: '18px' }}>{product.name}</h3>

      <p style={{ color: '#666', fontSize: '14px', margin: '8px 0' }}>
        {product.description}
      </p>

      <p style={{ fontSize: '20px', fontWeight: 'bold', margin: '12px 0' }}>
        ${product.price.toFixed(2)}
      </p>

      <p style={{ fontSize: '12px', color: isOutOfStock ? 'red' : '#666' }}>
        {isOutOfStock ? 'Out of Stock' : `${product.stock} in stock`}
      </p>

      <button
        onClick={() => onAddToCart(product)}
        disabled={isOutOfStock}
        style={{
          width: '100%',
          padding: '10px',
          marginTop: '12px',
          backgroundColor: isOutOfStock ? '#ccc' : '#007bff',
          color: 'white',
          border: 'none',
          borderRadius: '4px',
          cursor: isOutOfStock ? 'not-allowed' : 'pointer',
          fontSize: '14px',
          fontWeight: 'bold',
        }}
      >
        {isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
      </button>
    </div>
  );
}

export default ProductCard;
```

### Step 8: ProductList Component

```jsx
// components/ProductList.js
import ProductCard from './ProductCard';

function ProductList({ products, loading, error, onAddToCart, onRetry }) {
  if (loading) {
    return (
      <div style={{ padding: '40px', textAlign: 'center' }}>
        <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚è≥</div>
        <p>Loading products...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div style={{ padding: '40px', textAlign: 'center' }}>
        <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚ùå</div>
        <p style={{ color: 'red', marginBottom: '16px' }}>Error: {error}</p>
        <button
          onClick={onRetry}
          style={{
            padding: '10px 20px',
            backgroundColor: '#007bff',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer',
          }}
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div>
      <h2 style={{ marginBottom: '20px' }}>Products</h2>

      <div
        style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',
          gap: '20px',
        }}
      >
        {products.map((product) => (
          <ProductCard
            key={product.id}
            product={product}
            onAddToCart={onAddToCart}
          />
        ))}
      </div>
    </div>
  );
}

export default ProductList;
```

### Step 9: CartItem Component

```jsx
// components/CartItem.js
function CartItem({ item, onUpdateQuantity, onRemove }) {
  const { product, quantity, _optimistic } = item;

  return (
    <div
      style={{
        display: 'flex',
        alignItems: 'center',
        padding: '16px',
        borderBottom: '1px solid #ddd',
        opacity: _optimistic ? 0.6 : 1,
        transition: 'opacity 0.3s',
      }}
    >
      {/* Product Image */}
      <div style={{ fontSize: '32px', marginRight: '16px' }}>
        {product.image}
      </div>

      {/* Product Info */}
      <div style={{ flex: 1 }}>
        <h4 style={{ margin: '0 0 4px 0' }}>{product.name}</h4>
        <p style={{ margin: 0, color: '#666', fontSize: '14px' }}>
          ${product.price.toFixed(2)} each
        </p>
      </div>

      {/* Quantity Controls */}
      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
        <button
          onClick={() => onUpdateQuantity(product.id, quantity - 1)}
          disabled={_optimistic}
          style={{
            width: '30px',
            height: '30px',
            border: '1px solid #ddd',
            backgroundColor: 'white',
            cursor: _optimistic ? 'not-allowed' : 'pointer',
            borderRadius: '4px',
          }}
        >
          -
        </button>

        <span style={{ minWidth: '30px', textAlign: 'center' }}>
          {quantity}
        </span>

        <button
          onClick={() => onUpdateQuantity(product.id, quantity + 1)}
          disabled={_optimistic}
          style={{
            width: '30px',
            height: '30px',
            border: '1px solid #ddd',
            backgroundColor: 'white',
            cursor: _optimistic ? 'not-allowed' : 'pointer',
            borderRadius: '4px',
          }}
        >
          +
        </button>
      </div>

      {/* Subtotal */}
      <div
        style={{
          minWidth: '80px',
          textAlign: 'right',
          fontWeight: 'bold',
          marginLeft: '16px',
        }}
      >
        ${(product.price * quantity).toFixed(2)}
      </div>

      {/* Remove Button */}
      <button
        onClick={() => onRemove(product.id)}
        disabled={_optimistic}
        style={{
          marginLeft: '16px',
          padding: '8px 12px',
          backgroundColor: '#dc3545',
          color: 'white',
          border: 'none',
          borderRadius: '4px',
          cursor: _optimistic ? 'not-allowed' : 'pointer',
        }}
      >
        Remove
      </button>

      {/* Optimistic Indicator */}
      {_optimistic && (
        <span style={{ marginLeft: '8px', fontSize: '12px', color: '#666' }}>
          Saving...
        </span>
      )}
    </div>
  );
}

export default CartItem;
```

### Step 10: ShoppingCart Component

```jsx
// components/ShoppingCart.js
import { useState } from 'react';
import CartItem from './CartItem';
import useDiscounts from '../hooks/useDiscounts';

function ShoppingCart({
  items,
  discount,
  subtotal,
  discountAmount,
  tax,
  total,
  onUpdateQuantity,
  onRemove,
  onClearCart,
  onApplyDiscount,
  onRemoveDiscount,
  onUndo,
  canUndo,
}) {
  const { inputCode, setInputCode, validationError, validateCode, clearError } =
    useDiscounts();

  const handleApplyDiscount = () => {
    const validDiscount = validateCode(inputCode);

    if (validDiscount) {
      onApplyDiscount(validDiscount);
    }
  };

  if (items.length === 0) {
    return (
      <div style={{ padding: '40px', textAlign: 'center' }}>
        <div style={{ fontSize: '64px', marginBottom: '16px' }}>üõí</div>
        <h2>Your cart is empty</h2>
        <p style={{ color: '#666' }}>Add some products to get started!</p>

        {canUndo && (
          <button
            onClick={onUndo}
            style={{
              marginTop: '16px',
              padding: '10px 20px',
              backgroundColor: '#28a745',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer',
            }}
          >
            ‚Ü∂ Undo Clear Cart
          </button>
        )}
      </div>
    );
  }

  return (
    <div>
      <div
        style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '20px',
        }}
      >
        <h2 style={{ margin: 0 }}>Shopping Cart ({items.length})</h2>

        <div style={{ display: 'flex', gap: '8px' }}>
          {canUndo && (
            <button
              onClick={onUndo}
              style={{
                padding: '8px 16px',
                backgroundColor: '#28a745',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
              }}
            >
              ‚Ü∂ Undo
            </button>
          )}

          <button
            onClick={onClearCart}
            style={{
              padding: '8px 16px',
              backgroundColor: '#dc3545',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer',
            }}
          >
            Clear Cart
          </button>
        </div>
      </div>

      {/* Cart Items */}
      <div
        style={{
          border: '1px solid #ddd',
          borderRadius: '8px',
          marginBottom: '20px',
        }}
      >
        {items.map((item) => (
          <CartItem
            key={item.productId}
            item={item}
            onUpdateQuantity={onUpdateQuantity}
            onRemove={onRemove}
          />
        ))}
      </div>

      {/* Discount Code */}
      <div
        style={{
          padding: '16px',
          border: '1px solid #ddd',
          borderRadius: '8px',
          marginBottom: '20px',
        }}
      >
        <h3 style={{ margin: '0 0 12px 0' }}>Discount Code</h3>

        {discount ? (
          <div
            style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
            }}
          >
            <div>
              <strong>{discount.code}</strong> - {discount.description}
            </div>
            <button
              onClick={onRemoveDiscount}
              style={{
                padding: '6px 12px',
                backgroundColor: '#dc3545',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
              }}
            >
              Remove
            </button>
          </div>
        ) : (
          <div>
            <div style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
              <input
                type='text'
                value={inputCode}
                onChange={(e) => {
                  setInputCode(e.target.value.toUpperCase());
                  clearError();
                }}
                placeholder='Enter code (e.g., SAVE10)'
                style={{
                  flex: 1,
                  padding: '8px',
                  border: '1px solid #ddd',
                  borderRadius: '4px',
                }}
              />
              <button
                onClick={handleApplyDiscount}
                style={{
                  padding: '8px 16px',
                  backgroundColor: '#28a745',
                  color: 'white',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer',
                }}
              >
                Apply
              </button>
            </div>

            {validationError && (
              <p
                style={{ margin: '4px 0 0 0', color: 'red', fontSize: '14px' }}
              >
                {validationError}
              </p>
            )}

            <p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#666' }}>
              Available codes: SAVE10, SAVE20, FLAT15
            </p>
          </div>
        )}
      </div>

      {/* Order Summary */}
      <div
        style={{
          padding: '20px',
          border: '1px solid #ddd',
          borderRadius: '8px',
          backgroundColor: '#f8f9fa',
        }}
      >
        <h3 style={{ margin: '0 0 16px 0' }}>Order Summary</h3>

        <div
          style={{
            marginBottom: '8px',
            display: 'flex',
            justifyContent: 'space-between',
          }}
        >
          <span>Subtotal:</span>
          <span>${subtotal.toFixed(2)}</span>
        </div>

        {discountAmount > 0 && (
          <div
            style={{
              marginBottom: '8px',
              display: 'flex',
              justifyContent: 'space-between',
              color: '#28a745',
            }}
          >
            <span>Discount:</span>
            <span>-${discountAmount.toFixed(2)}</span>
          </div>
        )}

        <div
          style={{
            marginBottom: '8px',
            display: 'flex',
            justifyContent: 'space-between',
          }}
        >
          <span>Tax (10%):</span>
          <span>${tax.toFixed(2)}</span>
        </div>

        <hr style={{ margin: '12px 0' }} />

        <div
          style={{
            display: 'flex',
            justifyContent: 'space-between',
            fontSize: '20px',
            fontWeight: 'bold',
          }}
        >
          <span>Total:</span>
          <span>${total.toFixed(2)}</span>
        </div>

        <button
          style={{
            width: '100%',
            marginTop: '20px',
            padding: '14px',
            backgroundColor: '#007bff',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            fontSize: '16px',
            fontWeight: 'bold',
            cursor: 'pointer',
          }}
          onClick={() => alert('Checkout functionality would go here!')}
        >
          Proceed to Checkout
        </button>
      </div>
    </div>
  );
}

export default ShoppingCart;
```

### Step 11: Main App Component

```jsx
// App.js
import { useState } from 'react';
import useProducts from './hooks/useProducts';
import useCart from './hooks/useCart';
import ProductList from './components/ProductList';
import ShoppingCart from './components/ShoppingCart';

function App() {
  const [activeTab, setActiveTab] = useState('products'); // 'products' | 'cart'

  // Products
  const {
    products,
    loading: productsLoading,
    error: productsError,
    retry,
  } = useProducts();

  // Cart
  const {
    items,
    discount,
    error: cartError,
    subtotal,
    discountAmount,
    tax,
    total,
    itemCount,
    addToCart,
    updateQuantity,
    removeFromCart,
    clearCart,
    undo,
    applyDiscount,
    removeDiscount,
    clearError,
    canUndo,
  } = useCart();

  return (
    <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '20px' }}>
      {/* Header */}
      <header
        style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '30px',
          paddingBottom: '20px',
          borderBottom: '2px solid #ddd',
        }}
      >
        <h1 style={{ margin: 0 }}>üõçÔ∏è E-Commerce Store</h1>

        <div style={{ display: 'flex', gap: '16px' }}>
          <button
            onClick={() => setActiveTab('products')}
            style={{
              padding: '10px 20px',
              backgroundColor: activeTab === 'products' ? '#007bff' : '#fff',
              color: activeTab === 'products' ? '#fff' : '#000',
              border: '1px solid #007bff',
              borderRadius: '4px',
              cursor: 'pointer',
              fontWeight: activeTab === 'products' ? 'bold' : 'normal',
            }}
          >
            Products
          </button>

          <button
            onClick={() => setActiveTab('cart')}
            style={{
              padding: '10px 20px',
              backgroundColor: activeTab === 'cart' ? '#007bff' : '#fff',
              color: activeTab === 'cart' ? '#fff' : '#000',
              border: '1px solid #007bff',
              borderRadius: '4px',
              cursor: 'pointer',
              fontWeight: activeTab === 'cart' ? 'bold' : 'normal',
              position: 'relative',
            }}
          >
            Cart
            {itemCount > 0 && (
              <span
                style={{
                  position: 'absolute',
                  top: '-8px',
                  right: '-8px',
                  backgroundColor: '#dc3545',
                  color: 'white',
                  borderRadius: '50%',
                  width: '24px',
                  height: '24px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '12px',
                  fontWeight: 'bold',
                }}
              >
                {itemCount}
              </span>
            )}
          </button>
        </div>
      </header>

      {/* Error Display */}
      {cartError && (
        <div
          style={{
            padding: '12px',
            marginBottom: '20px',
            backgroundColor: '#f8d7da',
            border: '1px solid #f5c6cb',
            borderRadius: '4px',
            color: '#721c24',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
          }}
        >
          <span>‚ùå {cartError}</span>
          <button
            onClick={clearError}
            style={{
              padding: '4px 8px',
              backgroundColor: 'transparent',
              border: 'none',
              cursor: 'pointer',
              fontSize: '18px',
            }}
          >
            ‚úï
          </button>
        </div>
      )}

      {/* Main Content */}
      {activeTab === 'products' ? (
        <ProductList
          products={products}
          loading={productsLoading}
          error={productsError}
          onAddToCart={addToCart}
          onRetry={retry}
        />
      ) : (
        <ShoppingCart
          items={items}
          discount={discount}
          subtotal={subtotal}
          discountAmount={discountAmount}
          tax={tax}
          total={total}
          onUpdateQuantity={updateQuantity}
          onRemove={removeFromCart}
          onClearCart={clearCart}
          onApplyDiscount={applyDiscount}
          onRemoveDiscount={removeDiscount}
          onUndo={undo}
          canUndo={canUndo}
        />
      )}
    </div>
  );
}

export default App;
```

---

## üß™ PH·∫¶N 5: TESTING & EDGE CASES (20 ph√∫t)

### Manual Testing Checklist

```markdown
## Feature Testing

### Products

- [ ] Products load on mount
- [ ] Loading state displays
- [ ] Error state displays with retry button
- [ ] Retry works after error
- [ ] Out of stock products disabled

### Add to Cart

- [ ] Add item increases cart count
- [ ] Add same item increments quantity
- [ ] Out of stock items cannot be added
- [ ] Optimistic update (instant UI)
- [ ] Rollback on API failure

### Cart Operations

- [ ] Update quantity works (+/-)
- [ ] Quantity 0 removes item
- [ ] Remove button works
- [ ] Clear cart shows confirmation
- [ ] Undo restores last state

### Discount Codes

- [ ] Valid code applies discount
- [ ] Invalid code shows error
- [ ] Percentage discount calculates correctly
- [ ] Fixed discount calculates correctly
- [ ] Remove discount works
- [ ] Only one discount at a time

### Persistence

- [ ] Cart persists after page refresh
- [ ] Discount persists after refresh
- [ ] Empty cart persists

### Calculations

- [ ] Subtotal correct
- [ ] Discount amount correct
- [ ] Tax (10%) correct
- [ ] Total correct

### Edge Cases

- [ ] Empty cart displays message
- [ ] API failures handled gracefully
- [ ] Multiple rapid clicks handled
- [ ] Large quantities work
- [ ] Decimal prices calculate correctly
```

### Common Edge Cases to Test

```jsx
// Test Scenarios:

// 1. Rapid clicks
// Click "Add to Cart" 5 times quickly
// Expected: Only 1 optimistic update, others queued

// 2. Offline simulation
// Disable network in DevTools
// Try to add to cart
// Expected: Error message, rollback

// 3. Race condition
// Add item, immediately remove
// Expected: Correct final state

// 4. Large discount
// Apply FLAT15 to $10 item
// Expected: Discount capped at subtotal (not negative)

// 5. Stock limit
// Try to add 100 of item with stock 10
// Expected: Prevented or capped

// 6. localStorage full
// Fill localStorage to quota
// Expected: Graceful degradation
```

---

## üìä PH·∫¶N 6: PROJECT REVIEW (15 ph√∫t)

### Architecture Review

**‚úÖ What We Built:**

1. **State Management:**
   - useReducer for complex cart logic
   - Normalized state structure
   - Optimistic updates pattern
   - Undo/Redo functionality

2. **Custom Hooks:**
   - `useProducts` - Data fetching
   - `useCart` - Cart operations
   - `useLocalStorage` - Persistence
   - `useDiscounts` - Discount validation

3. **Patterns Used:**
   - Hook composition
   - Optimistic UI
   - Error handling & retry
   - localStorage sync

### Code Quality Checklist

**State Management:**

- [x] Reducer pure functions
- [x] Immutable updates
- [x] Clear action types
- [x] Default case in reducer

**Custom Hooks:**

- [x] Descriptive names (use\*)
- [x] Single responsibility
- [x] Reusable logic
- [x] Proper dependencies

**Error Handling:**

- [x] Try-catch blocks
- [x] User-friendly messages
- [x] Rollback on failures
- [x] Retry functionality

**Performance:**

- [x] Optimistic updates (instant UI)
- [x] Debounced operations (where needed)
- [x] Minimal re-renders

### Improvements for Production

```jsx
// 1. Add TypeScript
interface CartItem {
  productId: number;
  quantity: number;
  product: Product;
  _optimistic?: boolean;
}

// 2. Add proper error boundaries
class ErrorBoundary extends React.Component { ... }

// 3. Add loading skeletons
function ProductSkeleton() { ... }

// 4. Add analytics
const trackAddToCart = (product) => {
  analytics.track('Add to Cart', { productId: product.id });
};

// 5. Add tests
test('useCart adds item correctly', () => { ... });

// 6. Add accessibility
<button aria-label={`Add ${product.name} to cart`}>
  Add to Cart
</button>

// 7. Add SEO metadata
<Helmet>
  <title>Shopping Cart - {itemCount} items</title>
</Helmet>

// 8. Add mobile responsive design
@media (max-width: 768px) {
  .product-grid { grid-template-columns: 1fr; }
}

// 9. Add real API integration
const API_BASE = process.env.REACT_APP_API_URL;

// 10. Add authentication
const { user, isAuthenticated } = useAuth();
```

---

## üè† B√ÄI T·∫¨P V·ªÄ NH√Ä

### B·∫Øt bu·ªôc (60 ph√∫t)

**B√†i 1: Add Product Filtering**

Requirements:

1. Add filter dropdown: All | In Stock | Out of Stock
2. Add search by product name
3. Combine filters (search + stock filter)
4. Show "No results" when filters return empty

Hints:

- Create `useProductFilters` hook
- Filter logic in reducer or derived state
- Debounce search input

### N√¢ng cao (90 ph√∫t)

**B√†i 2: Add Wishlist Feature**

Requirements:

1. Heart icon on each product
2. Add/Remove from wishlist
3. Wishlist page (separate tab)
4. Move from wishlist to cart
5. Persist wishlist to localStorage
6. Wishlist badge count

State shape:

```jsx
{
  wishlist: [{ productId, product, addedAt }];
}
```

Hooks needed:

- `useWishlist` (similar to useCart)
- Reuse `useLocalStorage`

---

## üìö T√ÄI LI·ªÜU THAM KH·∫¢O

### Review Materials

1. **useReducer Patterns:**
   - Review Ng√†y 26-27
   - Optimistic updates (Ng√†y 28)
   - Custom hooks (Ng√†y 29)

2. **Shopping Cart References:**
   - https://github.com/vercel/commerce
   - https://github.com/stripe/stripe-react-native

---

## üîó K·∫æT N·ªêI KI·∫æN TH·ª®C

### Ki·∫øn th·ª©c ƒë√£ √°p d·ª•ng

- **Ng√†y 26-27:** useReducer advanced patterns ‚úÖ
- **Ng√†y 28:** useReducer + useEffect ‚úÖ
- **Ng√†y 29:** Custom hooks ‚úÖ
- **Ng√†y 11-14:** useState basics ‚úÖ
- **Ng√†y 16-20:** useEffect patterns ‚úÖ

### H∆∞·ªõng t·ªõi

- **Ng√†y 31-34:** Performance Optimization
  - useMemo for cart calculations
  - useCallback for cart actions
  - Prevent unnecessary re-renders

- **Phase 5:** Context API
  - Global cart state
  - Share cart across app
  - useCartContext hook

---

## üí° SENIOR INSIGHTS

### Production Considerations

**1. Stock Management:**

```jsx
// Real-world: Check stock before confirming
const confirmAddToCart = async (product, quantity) => {
  const currentStock = await api.checkStock(product.id);

  if (currentStock < quantity) {
    throw new Error(`Only ${currentStock} available`);
  }

  // Proceed...
};
```

**2. Cart Expiration:**

```jsx
// Items expire after 15 minutes
const addToCart = (product) => {
  dispatch({
    type: 'ADD_ITEM',
    payload: {
      product,
      expiresAt: Date.now() + 15 * 60 * 1000,
    },
  });
};
```

**3. Analytics Integration:**

```jsx
const addToCart = (product) => {
  // Track event
  analytics.track('Add to Cart', {
    productId: product.id,
    price: product.price,
    category: product.category,
  });

  // Proceed with add
};
```

### War Stories

**Story 1: The Race Condition Bug**

> "Black Friday sale. Users spamming 'Add to Cart' ‚Üí 10 API calls for same item ‚Üí inventory oversold. Fix: Debounce + request deduplication. Lesson: Users will spam buttons, prepare for it!" - E-commerce Engineer

**Story 2: localStorage Quota**

> "Cart with 1000+ items (user testing limits) ‚Üí localStorage quota exceeded ‚Üí data loss. Fix: Compression + limit cart size. Lesson: Always handle quota errors!" - Frontend Lead

---

## üéØ PREVIEW NG√ÄY MAI

**Ng√†y 31: React Rendering Behavior - Understanding Re-renders**

B·∫°n s·∫Ω h·ªçc:

- ‚ú® Khi n√†o React re-renders
- ‚ú® Profiling v·ªõi React DevTools
- ‚ú® Unnecessary re-renders detection
- ‚ú® Optimization strategies
- ‚ú® Prepare for useMemo, useCallback

Chu·∫©n b·ªã:

- Install React DevTools extension
- Suy nghƒ©: Khi n√†o component re-render?
- Review today's project - c√≥ ch·ªó n√†o re-render kh√¥ng c·∫ßn thi·∫øt?

---

**üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh Project 4!**

B·∫°n ƒë√£ build:

- ‚úÖ Full shopping cart application
- ‚úÖ 4 custom hooks
- ‚úÖ Optimistic updates
- ‚úÖ localStorage persistence
- ‚úÖ Error handling & retry

Tomorrow: Optimize performance! üöÄ
